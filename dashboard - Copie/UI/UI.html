<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MMM Token Dashboard (Monad Testnet)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Ethers v6 (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>

  <style>
    /* === EMBEDDED CSS === */
    * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }

    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg-light: #f8fafc;
      --bg-card: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
    }

    .dark-mode {
      --primary: #818cf8;
      --primary-dark: #6366f1;
      --success: #34d399;
      --danger: #f87171;
      --bg-light: #0f172a;
      --bg-card: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
    }

    body {
      background: var(--bg-light);
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .dark-mode .glass-card {
      background: rgba(30, 41, 59, 0.95);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .wallet-card {
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .wallet-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(99, 102, 241, 0.1);
      border-color: var(--primary);
    }

    .gradient-text {
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .gradient-bg { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }

    .btn-primary {
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      color: white;
      transition: all 0.3s ease;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
    }

    .btn-success {
      background: linear-gradient(90deg, #10b981, #059669);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
    }

    .fade-in { animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .slide-in { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    .status-success {
      background: linear-gradient(90deg, #d1fae5, #a7f3d0);
      color: #065f46;
      border-left: 4px solid #10b981;
    }

    .status-error {
      background: linear-gradient(90deg, #fee2e2, #fecaca);
      color: #991b1b;
      border-left: 4px solid #ef4444;
    }

    .status-info {
      background: linear-gradient(90deg, #dbeafe, #bfdbfe);
      color: #1e40af;
      border-left: 4px solid #3b82f6;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .progress-bar {
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      overflow: hidden;
    }

    .dark-mode .progress-bar { background: #334155; }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-success { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .badge-warning { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
    .dark-mode ::-webkit-scrollbar-track { background: #334155; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .dark-mode ::-webkit-scrollbar-thumb { background: #475569; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #e2e8f0;
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .dark-mode .spinner { border-color: #475569; border-top-color: #818cf8; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .confetti {
      position: fixed;
      width: 10px;
      height: 20px;
      opacity: 0;
      z-index: 9999;
      animation: confettiFall 3s linear forwards;
    }

    @keyframes confettiFall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
  </style>
</head>

<body class="min-h-screen p-4 md:p-8">
  <div class="max-w-7xl mx-auto">

    <!-- Header -->
    <header class="mb-8 md:mb-12">
      <div class="flex flex-col md:flex-row justify-between items-center mb-6">
        <div class="mb-4 md:mb-0">
          <h1 class="text-3xl md:text-4xl font-bold gradient-text mb-2">
            <i class="fas fa-coins mr-3"></i>MMM Token Dashboard
          </h1>
          <p class="text-gray-600 dark:text-gray-400">
            Monad Testnet • MMM balance + claimable from tracker • Send & Claim (connected wallet only)
          </p>
          <div class="mt-2 text-xs text-gray-500 dark:text-gray-400 font-mono">
            MMM: <a id="mmmLink" class="underline" target="_blank" rel="noreferrer"></a><br/>
            Tracker: <a id="trackerLink" class="underline" target="_blank" rel="noreferrer"></a>
          </div>
        </div>

        <div class="flex items-center space-x-3">
          <button onclick="toggleDarkMode()" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
            <i id="themeIcon" class="fas fa-moon"></i>
          </button>

          <button onclick="connectWallet()" class="btn-primary px-6 py-3 rounded-xl font-semibold flex items-center">
            <i class="fas fa-wallet mr-2"></i>
            <span id="connectLabel">Connect Wallet</span>
          </button>
        </div>
      </div>

      <div class="glass-card rounded-2xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
        <div class="text-sm text-gray-600 dark:text-gray-300">
          Network: <span class="font-semibold">Monad Testnet</span> (ChainId: <span class="font-mono">10143</span>)
        </div>
        <div class="text-sm text-gray-600 dark:text-gray-300">
          Connected: <span id="connectedAddr" class="font-mono">Not connected</span>
        </div>
      </div>
    </header>

    <!-- Stats Summary -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
      <div class="glass-card rounded-2xl p-6 text-white gradient-bg">
        <p class="text-sm opacity-90">Total Holdings (watched wallets)</p>
        <p id="total-holdings" class="text-3xl font-bold">0 MMM</p>
        <div class="flex items-center mt-2">
          <i class="fas fa-signal text-green-300 mr-2"></i>
          <span class="text-sm">On-chain</span>
        </div>
      </div>
      <div class="glass-card rounded-2xl p-6 text-white" style="background: linear-gradient(135deg, #10b981, #059669);">
        <p class="text-sm opacity-90">Total Claimable (watched wallets)</p>
        <p id="total-claimable" class="text-3xl font-bold">0 MMM</p>
        <div class="flex items-center mt-2">
          <i class="fas fa-gift mr-2"></i>
          <span class="text-sm">From tracker</span>
        </div>
      </div>
      <div class="glass-card rounded-2xl p-6 text-white" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
        <p class="text-sm opacity-90">Last refresh</p>
        <p id="last-refresh" class="text-3xl font-bold">—</p>
        <div class="flex items-center mt-2">
          <i class="fas fa-clock mr-2"></i>
          <span class="text-sm">Local time</span>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Wallets Section -->
      <div class="lg:col-span-2">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Watched Wallets</h2>
          <div class="flex gap-2">
            <button onclick="promptAddWatchAddress()" class="text-gray-600 dark:text-gray-400 hover:text-blue-600">
              <i class="fas fa-plus mr-2"></i>Add Watch Address
            </button>
            <button onclick="refreshBalances()" class="text-gray-600 dark:text-gray-400 hover:text-blue-600">
              <i class="fas fa-sync-alt mr-2"></i>Refresh
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="wallets-container"></div>
      </div>

      <!-- Send Tokens Section -->
      <div class="lg:col-span-1">
        <div class="glass-card rounded-2xl p-6 sticky top-8">
          <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">
            <i class="fas fa-paper-plane mr-3 text-blue-600"></i> Send MMM
          </h2>

          <div class="space-y-6">
            <div>
              <label class="block text-gray-700 dark:text-gray-300 mb-2 font-medium">
                <i class="fas fa-wallet mr-2"></i>Source (must be connected wallet)
              </label>
              <select id="wallet-select" class="w-full p-4 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl">
                <option value="">Connect wallet first</option>
              </select>
            </div>

            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
              <div class="flex justify-between items-center">
                <span class="text-gray-700 dark:text-gray-300">Available Balance:</span>
                <span id="available-balance" class="text-xl font-bold text-blue-600">0 MMM</span>
              </div>
            </div>

            <div>
              <label class="block text-gray-700 dark:text-gray-300 mb-2 font-medium">
                <i class="fas fa-coins mr-2"></i>Amount (MMM)
              </label>
              <input type="number" id="amount" min="0" step="0.000001" placeholder="0.00"
                     class="w-full p-4 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl">
              <div class="flex justify-between mt-2">
                <button type="button" onclick="setAmount(0.25)" class="text-sm bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 px-3 py-1 rounded-lg">25%</button>
                <button type="button" onclick="setAmount(0.5)" class="text-sm bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 px-3 py-1 rounded-lg">50%</button>
                <button type="button" onclick="setAmount(0.75)" class="text-sm bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 px-3 py-1 rounded-lg">75%</button>
                <button type="button" onclick="setAmount(1)" class="text-sm bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 px-3 py-1 rounded-lg">MAX</button>
              </div>
            </div>

            <div>
              <label class="block text-gray-700 dark:text-gray-300 mb-2 font-medium">
                <i class="fas fa-user-circle mr-2"></i>Recipient Address
              </label>
              <input type="text" id="recipient" placeholder="0x..."
                     class="w-full p-4 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl font-mono">
            </div>

            <div id="status" class="hidden p-4 rounded-xl"></div>

            <button id="send-btn" onclick="sendTokens()" class="w-full btn-primary py-4 rounded-xl font-bold text-lg">
              <i class="fas fa-paper-plane mr-3"></i>Send Tokens
            </button>

            <div class="border-t dark:border-gray-700 pt-4">
              <p class="text-gray-600 dark:text-gray-400 mb-3 font-medium">Quick Actions:</p>
              <div class="grid grid-cols-2 gap-2">
                <button onclick="watchConnectedWallet()" class="bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 p-3 rounded-lg text-sm">
                  Watch Connected
                </button>
                <button onclick="resetDashboard()" class="bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 p-3 rounded-lg text-sm">
                  Reset Watches
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Transaction History -->
    <div class="mt-12 glass-card rounded-2xl p-6">
      <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6">
        <i class="fas fa-history mr-3"></i>Recent Actions (local)
      </h3>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="text-left text-gray-600 dark:text-gray-400 border-b dark:border-gray-700">
              <th class="pb-3">Type</th>
              <th class="pb-3">Amount</th>
              <th class="pb-3">Address / Tx</th>
              <th class="pb-3">Status</th>
              <th class="pb-3">Date</th>
            </tr>
          </thead>
          <tbody id="transactions-body"></tbody>
        </table>
      </div>
      <p class="mt-3 text-xs text-gray-500 dark:text-gray-400">
        Note: Explorer confirmations are the source of truth. This table is a local log.
      </p>
    </div>

    <!-- Footer -->
    <footer class="mt-12 pt-8 border-t dark:border-gray-800 text-center text-gray-600 dark:text-gray-400 text-sm">
      <p>MMM Token Dashboard • Single HTML File • Ethers v6 • Monad Testnet</p>
      <p class="mt-2"><i class="fas fa-code mr-1"></i>All CSS & JavaScript embedded in one file</p>
    </footer>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl text-center">
      <div class="spinner mx-auto mb-4"></div>
      <p id="loading-text" class="text-gray-800 dark:text-white">Processing...</p>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG (your last values)
    // =========================
    const CONFIG = {
      chainIdDec: 10143,                 // Monad Testnet
      chainIdHex: "0x279F",
      chainName: "Monad Testnet",
      nativeSymbol: "MON",
      rpcUrls: [
        "https://rpc.ankr.com/monad_testnet",
        "https://testnet-rpc.monad.xyz"
      ],
      explorerBase: "https://testnet.monadvision.com",
      // From your last run output:
      mmmToken:  "0x1Ad3565c099F5242012Fb1f21aaA729EFcf75c16",
      tracker:   "0x5B870DAa512DB9DADEbD53d55045BAE798B4B86B",
      // Optional: if you want a default watched address (your Tester):
      defaultWatch: ["0x22BC7a72000faE48a67520c056C0944d9a675412"]
    };

    // ============
    // ABIs (minimal)
    // ============
    const ERC20_ABI = [
      "function name() view returns (string)",
      "function symbol() view returns (string)",
      "function decimals() view returns (uint8)",
      "function balanceOf(address) view returns (uint256)",
      "function transfer(address to, uint256 amount) returns (bool)"
    ];

    // Your tracker is a custom dividend/reward tracker. We support several common view/claim shapes
    // and auto-pick what exists at runtime (try/catch).
    const TRACKER_ABI = [
      // view candidates
      "function claimable(address) view returns (uint256)",
      "function pendingReward(address) view returns (uint256)",
      "function withdrawableDividendOf(address) view returns (uint256)",
      "function withdrawableRewardsOf(address) view returns (uint256)",
      "function getAccount(address) view returns (address,int256,int256,uint256,uint256,uint256,uint256,uint256)",

      // claim candidates
      "function claim()",
      "function claim(address)",
      "function claimDividend()",
      "function processAccount(address,bool) returns (bool)"
    ];

    // =========================
    // State
    // =========================
    let isDarkMode = localStorage.getItem("darkMode") === "true";
    let provider = null;          // BrowserProvider (metamask)
    let signer = null;            // signer
    let connectedAddress = null;  // 0x...
    let readProvider = null;      // JsonRpcProvider fallback (read-only)

    let token = null;             // ERC20 contract (read with provider)
    let tokenWithSigner = null;   // ERC20 contract (write)
    let tracker = null;           // tracker contract (read)
    let trackerWithSigner = null; // tracker contract (write)

    // watched wallets = array of { id, name, address, mmmHoldings, claimable, isConnected }
    let wallets = [];
    // local action log
    let transactions = [];

    // =========================
    // Init
    // =========================
    document.addEventListener("DOMContentLoaded", async function () {
      // Theme
      if (isDarkMode) {
        document.body.classList.add("dark-mode");
        document.getElementById("themeIcon").className = "fas fa-sun";
      }

      // Links
      document.getElementById("mmmLink").textContent = CONFIG.mmmToken;
      document.getElementById("trackerLink").textContent = CONFIG.tracker;
      document.getElementById("mmmLink").href = `${CONFIG.explorerBase}/address/${CONFIG.mmmToken}`;
      document.getElementById("trackerLink").href = `${CONFIG.explorerBase}/address/${CONFIG.tracker}`;

      // Read-only provider (no wallet needed) for refreshing watched balances
      readProvider = new ethers.JsonRpcProvider(CONFIG.rpcUrls[0]);

      // Load local storage
      loadData();

      // Ensure default watch exists (only if nothing saved)
      if (wallets.length === 0 && Array.isArray(CONFIG.defaultWatch) && CONFIG.defaultWatch.length) {
        wallets = CONFIG.defaultWatch.map((addr, i) => ({
          id: String(i + 1),
          name: `Watched #${i + 1}`,
          address: ethers.getAddress(addr),
          mmmHoldings: 0,
          claimable: 0,
          isConnected: false
        }));
        saveData();
      }

      // Setup contracts read-only
      await initReadContracts();

      // UI
      renderWallets();
      renderTransactions();
      updateStats();
      await refreshBalances(); // first on-chain fetch

      // Listeners
      document.getElementById("wallet-select").addEventListener("change", updateAvailableBalance);
      document.getElementById("amount").addEventListener("input", validateAmount);

      // Auto-save
      setInterval(saveData, 30000);

      // If Metamask already connected, reflect it
      if (window.ethereum) {
        try {
          const accounts = await window.ethereum.request({ method: "eth_accounts" });
          if (accounts && accounts.length) {
            await connectWallet(true);
          }
        } catch (_) {}
      }
    });

    async function initReadContracts() {
      token = new ethers.Contract(CONFIG.mmmToken, ERC20_ABI, readProvider);
      tracker = new ethers.Contract(CONFIG.tracker, TRACKER_ABI, readProvider);
    }

    async function initWriteContracts() {
      if (!signer) return;
      tokenWithSigner = new ethers.Contract(CONFIG.mmmToken, ERC20_ABI, signer);
      trackerWithSigner = new ethers.Contract(CONFIG.tracker, TRACKER_ABI, signer);
    }

    // =========================
    // Storage
    // =========================
    function loadData() {
      const savedWallets = localStorage.getItem("mmm_watch_wallets");
      const savedTx = localStorage.getItem("mmm_action_log");
      wallets = savedWallets ? JSON.parse(savedWallets) : [];
      transactions = savedTx ? JSON.parse(savedTx) : [];
    }

    function saveData() {
      localStorage.setItem("mmm_watch_wallets", JSON.stringify(wallets));
      localStorage.setItem("mmm_action_log", JSON.stringify(transactions));
    }

    // =========================
    // Formatting
    // =========================
    function formatNumber(num, decimals = 6) {
      const n = Number(num || 0);
      return n.toLocaleString("en-US", { minimumFractionDigits: 0, maximumFractionDigits: decimals });
    }

    function shortAddr(a) {
      if (!a) return "";
      return a.slice(0, 6) + "..." + a.slice(-4);
    }

    function nowDate() {
      return new Date().toISOString().split("T")[0];
    }

    // =========================
    // UI render
    // =========================
    function renderWallets() {
      const container = document.getElementById("wallets-container");
      container.innerHTML = "";

      wallets.forEach((w, idx) => {
        const color = w.isConnected ? "from-orange-500 to-red-500" : (idx % 2 ? "from-purple-500 to-pink-500" : "from-blue-500 to-cyan-500");
        const canClaimFromThis = connectedAddress && w.address && ethers.getAddress(w.address) === ethers.getAddress(connectedAddress) && (Number(w.claimable) > 0);

        const card = document.createElement("div");
        card.className = "wallet-card glass-card rounded-2xl p-6 fade-in";
        card.style.animationDelay = `${idx * 0.08}s`;

        const progressDen = (Number(w.claimable) + 1e-12); // show full when claimable is present
        const progressPct = Math.min(100, Math.max(0, (Number(w.claimable) / progressDen) * 100));

        card.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <div class="flex items-center">
              <div class="w-10 h-10 rounded-full bg-gradient-to-r ${color} flex items-center justify-center text-white mr-3">
                <i class="fas fa-wallet"></i>
              </div>
              <div>
                <h3 class="font-bold text-lg">${w.name || "Watched Wallet"}</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 font-mono">${shortAddr(w.address)} <a class="underline ml-2" target="_blank" rel="noreferrer" href="${CONFIG.explorerBase}/address/${w.address}">Explorer</a></p>
              </div>
            </div>
            <span class="badge ${w.isConnected ? "badge-success" : "badge-warning"}">
              ${w.isConnected ? "Connected" : "Watched"}
            </span>
          </div>

          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-gray-600 dark:text-gray-400">MMM Balance</span>
              <span class="text-2xl font-bold gradient-text">${formatNumber(w.mmmHoldings, 6)} MMM</span>
            </div>

            <div>
              <div class="flex justify-between items-center mb-1">
                <span class="text-gray-600 dark:text-gray-400">Claimable</span>
                <span class="text-lg font-semibold text-green-600 dark:text-green-400">${formatNumber(w.claimable, 6)} MMM</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progressPct}%;"></div>
              </div>
            </div>

            <div class="pt-2 flex gap-2">
              <button onclick="claimTokens('${w.address}')"
                      class="w-full btn-success py-3 rounded-xl font-medium flex items-center justify-center ${canClaimFromThis ? "" : "opacity-50 cursor-not-allowed"}"
                      ${canClaimFromThis ? "" : "disabled"}>
                <i class="fas fa-gift mr-2"></i>
                Claim (connected only)
              </button>

              <button onclick="removeWatchAddress('${w.address}')"
                      class="w-12 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-xl">
                <i class="fas fa-trash"></i>
              </button>
            </div>

            <p class="text-xs text-gray-500 dark:text-gray-400">
              Claim button is enabled only if this wallet equals the connected signer.
            </p>
          </div>
        `;
        container.appendChild(card);
      });

      renderSendWalletDropdown();
      updateAvailableBalance();
    }

    function renderSendWalletDropdown() {
      const select = document.getElementById("wallet-select");
      select.innerHTML = "";

      if (!connectedAddress) {
        select.innerHTML = '<option value="">Connect wallet first</option>';
        return;
      }

      // Only allow sending from the connected wallet (simple & safe)
      const opt = document.createElement("option");
      opt.value = connectedAddress;
      opt.textContent = `Connected (${shortAddr(connectedAddress)})`;
      select.appendChild(opt);
    }

    function renderTransactions() {
      const tbody = document.getElementById("transactions-body");
      tbody.innerHTML = "";

      (transactions || []).slice(0, 25).forEach((tx, index) => {
        const row = document.createElement("tr");
        row.className = "border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 fade-in";
        row.style.animationDelay = `${index * 0.03}s`;

        const isPositive = (tx.amount || 0) > 0;
        const icon = tx.icon || (tx.type === "Claim" ? "fa-gift" : "fa-paper-plane");
        const link = tx.txHash ? `${CONFIG.explorerBase}/tx/${tx.txHash}` : "";

        row.innerHTML = `
          <td class="py-4">
            <div class="flex items-center">
              <div class="w-10 h-10 rounded-full ${isPositive ? "bg-green-100 dark:bg-green-900/30" : "bg-blue-100 dark:bg-blue-900/30"} flex items-center justify-center mr-3">
                <i class="fas ${icon} ${isPositive ? "text-green-600 dark:text-green-400" : "text-blue-600 dark:text-blue-400"}"></i>
              </div>
              <span class="font-medium">${tx.type}</span>
            </div>
          </td>
          <td class="py-4">
            <span class="font-bold ${isPositive ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400"}">
              ${isPositive ? "+" : ""}${formatNumber(tx.amount, 6)} MMM
            </span>
          </td>
          <td class="py-4 font-mono text-sm">
            ${tx.address ? tx.address : (tx.txHash ? `<a class="underline" target="_blank" rel="noreferrer" href="${link}">${shortAddr(tx.txHash)}</a>` : "—")}
          </td>
          <td class="py-4">
            <span class="badge ${tx.status === "Completed" ? "badge-success" : "badge-warning"}">${tx.status}</span>
          </td>
          <td class="py-4">${tx.date}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateStats() {
      const totalHoldings = wallets.reduce((sum, w) => sum + Number(w.mmmHoldings || 0), 0);
      const totalClaimable = wallets.reduce((sum, w) => sum + Number(w.claimable || 0), 0);

      document.getElementById("total-holdings").textContent = `${formatNumber(totalHoldings, 6)} MMM`;
      document.getElementById("total-claimable").textContent = `${formatNumber(totalClaimable, 6)} MMM`;

      const t = new Date();
      document.getElementById("last-refresh").textContent = t.toLocaleTimeString();
    }

    function updateAvailableBalance() {
      const balEl = document.getElementById("available-balance");
      if (!connectedAddress) { balEl.textContent = "0 MMM"; return; }

      const w = wallets.find(x => x.address && ethers.getAddress(x.address) === ethers.getAddress(connectedAddress));
      balEl.textContent = w ? `${formatNumber(w.mmmHoldings, 6)} MMM` : "—";
    }

    // =========================
    // Wallet connect (MetaMask)
    // =========================
    async function connectWallet(silent = false) {
      try {
        if (!window.ethereum) {
          showStatus("No injected wallet found. Install MetaMask / Backpack EVM wallet.", "error");
          return;
        }

        showLoading("Connecting wallet...");

        provider = new ethers.BrowserProvider(window.ethereum);

        // Ensure correct network
        const net = await provider.getNetwork();
        if (Number(net.chainId) !== CONFIG.chainIdDec) {
          // attempt switch; if missing, add it
          try {
            await window.ethereum.request({
              method: "wallet_switchEthereumChain",
              params: [{ chainId: CONFIG.chainIdHex }]
            });
          } catch (e) {
            // 4902 = unknown chain
            if (e && e.code === 4902) {
              await window.ethereum.request({
                method: "wallet_addEthereumChain",
                params: [{
                  chainId: CONFIG.chainIdHex,
                  chainName: CONFIG.chainName,
                  nativeCurrency: { name: CONFIG.nativeSymbol, symbol: CONFIG.nativeSymbol, decimals: 18 },
                  rpcUrls: CONFIG.rpcUrls,
                  blockExplorerUrls: [CONFIG.explorerBase]
                }]
              });
            } else {
              throw e;
            }
          }
        }

        if (!silent) {
          await provider.send("eth_requestAccounts", []);
        }

        signer = await provider.getSigner();
        connectedAddress = await signer.getAddress();

        document.getElementById("connectedAddr").textContent = connectedAddress;
        document.getElementById("connectLabel").textContent = shortAddr(connectedAddress);

        await initWriteContracts();

        // mark watched wallets: connected
        wallets = wallets.map(w => ({
          ...w,
          isConnected: w.address && ethers.getAddress(w.address) === ethers.getAddress(connectedAddress)
        }));

        // if connected wallet isn't watched yet, add it (but do not force)
        renderWallets();
        await refreshBalances();

        showStatus(`Connected: ${connectedAddress}`, "success");
        hideLoading();

        // React to account/network changes
        window.ethereum.on?.("accountsChanged", async (accounts) => {
          if (!accounts || !accounts.length) {
            connectedAddress = null; signer = null; provider = null;
            document.getElementById("connectedAddr").textContent = "Not connected";
            document.getElementById("connectLabel").textContent = "Connect Wallet";
            wallets = wallets.map(w => ({ ...w, isConnected: false }));
            renderWallets();
            showStatus("Disconnected.", "info");
            return;
          }
          connectedAddress = ethers.getAddress(accounts[0]);
          signer = await provider.getSigner();
          await initWriteContracts();
          wallets = wallets.map(w => ({ ...w, isConnected: w.address && ethers.getAddress(w.address) === connectedAddress }));
          document.getElementById("connectedAddr").textContent = connectedAddress;
          document.getElementById("connectLabel").textContent = shortAddr(connectedAddress);
          renderWallets();
          await refreshBalances();
        });

        window.ethereum.on?.("chainChanged", async () => {
          // reload to re-init providers/contracts cleanly
          location.reload();
        });

      } catch (err) {
        hideLoading();
        if (!silent) showStatus(`Connect failed: ${err?.message || err}`, "error");
      }
    }

    // =========================
    // On-chain reads
    // =========================
    async function refreshBalances() {
      try {
        showLoading("Refreshing on-chain balances...");

        // Re-init readProvider if needed
        if (!readProvider) readProvider = new ethers.JsonRpcProvider(CONFIG.rpcUrls[0]);
        if (!token || !tracker) await initReadContracts();

        const decimals = await token.decimals().catch(() => 18);

        for (let i = 0; i < wallets.length; i++) {
          const addr = wallets[i].address;
          if (!addr) continue;

          // MMM balance
          const bal = await token.balanceOf(addr).catch(() => 0n);

          // Claimable from tracker (auto-detect)
          const claimRaw = await getClaimable(addr).catch(() => 0n);

          wallets[i].mmmHoldings = Number(ethers.formatUnits(bal, decimals));
          wallets[i].claimable = Number(ethers.formatUnits(claimRaw, decimals));
          wallets[i].isConnected = connectedAddress ? (ethers.getAddress(addr) === ethers.getAddress(connectedAddress)) : false;
        }

        saveData();
        renderWallets();
        updateStats();
        renderTransactions();

        showStatus("Balances refreshed (on-chain).", "success");
        hideLoading();
      } catch (err) {
        hideLoading();
        showStatus(`Refresh failed: ${err?.message || err}`, "error");
      }
    }

    // Try common claimable view functions on tracker; return uint256-like BigInt.
    async function getClaimable(addr) {
      // Most likely candidates in dividend trackers
      const candidates = [
        { fn: "claimable", args: [addr] },
        { fn: "pendingReward", args: [addr] },
        { fn: "withdrawableDividendOf", args: [addr] },
        { fn: "withdrawableRewardsOf", args: [addr] }
      ];

      for (const c of candidates) {
        try {
          const f = tracker.getFunction(c.fn);
          const v = await tracker[c.fn](...c.args);
          // ethers v6 returns BigInt for uints
          if (typeof v === "bigint") return v;
          // if returns tuple, ignore
        } catch (_) {}
      }

      // Fallback: getAccount(address) returns tuple with withdrawable at some index (varies per implementation),
      // so we do NOT guess indices here.
      return 0n;
    }

    // =========================
    // Claim (connected wallet)
    // =========================
    async function claimTokens(walletAddr) {
      try {
        if (!connectedAddress) { showStatus("Connect your wallet first.", "error"); return; }
        if (ethers.getAddress(walletAddr) !== ethers.getAddress(connectedAddress)) {
          showStatus("You can only claim for the connected signer address.", "error");
          return;
        }
        if (!trackerWithSigner) { showStatus("Tracker signer not ready. Reconnect wallet.", "error"); return; }

        showLoading("Claiming from tracker...");

        // Try claim methods in safest order.
        const claimMethods = [
          { fn: "claim", args: [] },
          { fn: "claimDividend", args: [] },
          { fn: "claim", args: [connectedAddress] },
          { fn: "processAccount", args: [connectedAddress, true] }
        ];

        let sent = null;
        let used = null;

        for (const m of claimMethods) {
          try {
            trackerWithSigner.getFunction(m.fn); // throws if not exists
            // send tx
            sent = await trackerWithSigner[m.fn](...m.args);
            used = `${m.fn}(${m.args.map(a => String(a)).join(",")})`;
            break;
          } catch (_) {}
        }

        if (!sent) {
          hideLoading();
          showStatus("Could not find a compatible claim function on the tracker contract. Tell me the exact claim function name and I’ll wire it in.", "error");
          return;
        }

        showStatus(`Claim tx sent via ${used}. Waiting confirmation...`, "info");
        const rcpt = await sent.wait();

        transactions.unshift({
          id: Date.now().toString(),
          type: "Claim",
          amount: 0, // we’ll refresh to show actual deltas
          address: "",
          txHash: rcpt?.hash || sent?.hash,
          status: "Completed",
          date: nowDate(),
          icon: "fa-gift"
        });

        showConfetti();
        await refreshBalances();

        showStatus(`Claim confirmed. Tx: ${shortAddr(rcpt?.hash || sent?.hash)}`, "success");
        hideLoading();
      } catch (err) {
        hideLoading();
        showStatus(`Claim failed: ${err?.message || err}`, "error");
      }
    }

    // =========================
    // Send MMM (ERC20 transfer)
    // =========================
    async function sendTokens() {
      try {
        const from = document.getElementById("wallet-select").value;
        const amount = parseFloat(document.getElementById("amount").value) || 0;
        const recipient = document.getElementById("recipient").value.trim();

        if (!connectedAddress || !signer || !tokenWithSigner) {
          showStatus("Connect wallet first.", "error");
          return;
        }

        if (!from || ethers.getAddress(from) !== ethers.getAddress(connectedAddress)) {
          showStatus("Source must be the connected wallet.", "error");
          return;
        }

        if (!recipient || !recipient.startsWith("0x") || recipient.length !== 42) {
          showStatus("Enter a valid recipient address.", "error");
          return;
        }

        if (amount <= 0) { showStatus("Enter a valid amount.", "error"); return; }

        // Read decimals & balance
        showLoading("Preparing transfer...");
        const decimals = await token.decimals().catch(() => 18);
        const bnAmount = ethers.parseUnits(String(amount), decimals);

        const bal = await token.balanceOf(connectedAddress);
        if (bnAmount > bal) {
          hideLoading();
          showStatus("Insufficient MMM balance.", "error");
          return;
        }

        showLoading("Sending MMM transfer...");
        const tx = await tokenWithSigner.transfer(ethers.getAddress(recipient), bnAmount);

        showStatus(`Transfer sent. Waiting confirmation...`, "info");
        const rcpt = await tx.wait();

        transactions.unshift({
          id: Date.now().toString(),
          type: "Send",
          amount: -amount,
          address: recipient,
          txHash: rcpt?.hash || tx?.hash,
          status: "Completed",
          date: nowDate(),
          icon: "fa-paper-plane"
        });

        // reset inputs
        document.getElementById("amount").value = "";
        document.getElementById("recipient").value = "";

        await refreshBalances();
        showStatus(`Transfer confirmed. Tx: ${shortAddr(rcpt?.hash || tx?.hash)}`, "success");
        hideLoading();
      } catch (err) {
        hideLoading();
        showStatus(`Send failed: ${err?.message || err}`, "error");
      }
    }

    function setAmount(percentage) {
      if (!connectedAddress) { showStatus("Connect wallet first.", "error"); return; }
      const w = wallets.find(x => x.address && ethers.getAddress(x.address) === ethers.getAddress(connectedAddress));
      if (!w) { showStatus("Watch your connected wallet first (Quick Actions → Watch Connected).", "info"); return; }

      const amt = Number(w.mmmHoldings || 0) * percentage;
      document.getElementById("amount").value = String(amt);
      validateAmount();
    }

    function validateAmount() {
      const amountInput = document.getElementById("amount");
      const amount = parseFloat(amountInput.value) || 0;

      if (!connectedAddress) return true;
      const w = wallets.find(x => x.address && ethers.getAddress(x.address) === ethers.getAddress(connectedAddress));
      if (!w) return true;

      if (amount > Number(w.mmmHoldings || 0)) {
        amountInput.classList.add("border-red-500");
        return false;
      }
      amountInput.classList.remove("border-red-500");
      return true;
    }

    // =========================
    // Watch list helpers
    // =========================
    function promptAddWatchAddress() {
      const addr = prompt("Enter an address to watch (0x...):");
      if (!addr) return;
      addWatchAddress(addr);
    }

    function addWatchAddress(addr) {
      try {
        const a = ethers.getAddress(addr);
        if (wallets.some(w => w.address && ethers.getAddress(w.address) === a)) {
          showStatus("Address already watched.", "info");
          return;
        }
        wallets.push({
          id: String(wallets.length + 1),
          name: `Watched #${wallets.length + 1}`,
          address: a,
          mmmHoldings: 0,
          claimable: 0,
          isConnected: connectedAddress ? (a === ethers.getAddress(connectedAddress)) : false
        });
        saveData();
        renderWallets();
        refreshBalances();
        showStatus(`Now watching: ${a}`, "success");
      } catch (_) {
        showStatus("Invalid address.", "error");
      }
    }

    function watchConnectedWallet() {
      if (!connectedAddress) { showStatus("Connect wallet first.", "error"); return; }
      addWatchAddress(connectedAddress);
    }

    function removeWatchAddress(addr) {
      try {
        const a = ethers.getAddress(addr);
        wallets = wallets.filter(w => !(w.address && ethers.getAddress(w.address) === a));
        // re-number IDs
        wallets = wallets.map((w, i) => ({ ...w, id: String(i + 1) }));
        saveData();
        renderWallets();
        updateStats();
        showStatus("Removed watch address.", "success");
      } catch (_) {
        showStatus("Could not remove (invalid address).", "error");
      }
    }

    function resetDashboard() {
      if (!confirm("Reset watched addresses and local action log?")) return;
      wallets = [];
      transactions = [];
      saveData();
      renderWallets();
      renderTransactions();
      updateStats();
      showStatus("Dashboard reset.", "success");
    }

    // =========================
    // Utility UI
    // =========================
    function showStatus(message, type = "info") {
      const statusEl = document.getElementById("status");
      statusEl.className = `p-4 rounded-xl slide-in status-${type}`;
      statusEl.innerHTML = `
        <div class="flex items-center">
          <i class="fas ${type === "success" ? "fa-check-circle" : type === "error" ? "fa-exclamation-triangle" : "fa-info-circle"} mr-3"></i>
          <span>${message}</span>
          <button onclick="this.parentElement.parentElement.classList.add('hidden')" class="ml-auto">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      statusEl.classList.remove("hidden");
      setTimeout(() => statusEl.classList.add("hidden"), 6000);
    }

    function showLoading(message = "Loading...") {
      const overlay = document.getElementById("loading-overlay");
      const text = document.getElementById("loading-text");
      text.textContent = message;
      overlay.classList.remove("hidden");
    }

    function hideLoading() {
      document.getElementById("loading-overlay").classList.add("hidden");
    }

    function showConfetti() {
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement("div");
        confetti.className = "confetti";
        confetti.style.left = `${Math.random() * 100}vw`;
        confetti.style.background = `hsl(${Math.random() * 360}, 100%, 60%)`;
        confetti.style.animationDelay = `${Math.random()}s`;
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 3000);
      }
    }

    function toggleDarkMode() {
      const body = document.body;
      const icon = document.getElementById("themeIcon");

      body.classList.toggle("dark-mode");
      isDarkMode = body.classList.contains("dark-mode");

      if (isDarkMode) {
        icon.className = "fas fa-sun";
        localStorage.setItem("darkMode", "true");
      } else {
        icon.className = "fas fa-moon";
        localStorage.setItem("darkMode", "false");
      }
    }

    // =========================
    // Expose globals
    // =========================
    window.connectWallet = connectWallet;
    window.refreshBalances = refreshBalances;
    window.claimTokens = claimTokens;
    window.sendTokens = sendTokens;
    window.setAmount = setAmount;

    window.promptAddWatchAddress = promptAddWatchAddress;
    window.addWatchAddress = addWatchAddress;
    window.removeWatchAddress = removeWatchAddress;
    window.watchConnectedWallet = watchConnectedWallet;
    window.resetDashboard = resetDashboard;

    window.toggleDarkMode = toggleDarkMode;
  </script>
</body>
</html>
